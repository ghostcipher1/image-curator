name: Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0

permissions:
  contents: write

jobs:
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for changelog

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests
      run: |
        pytest -v

    - name: Extract version from tag
      id: get_version
      run: |
        echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Generate changelog
      id: changelog
      run: |
        echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
        if [ $(git tag | wc -l) -gt 1 ]; then
          PREV_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            echo "## Changes since $PREV_TAG" >> $GITHUB_OUTPUT
            git log $PREV_TAG..HEAD --pretty=format:"- %s (%an)" --no-merges >> $GITHUB_OUTPUT
          else
            echo "## Initial Release" >> $GITHUB_OUTPUT
            echo "First public release of Image Curator" >> $GITHUB_OUTPUT
          fi
        else
          echo "## Initial Release" >> $GITHUB_OUTPUT
          echo "First public release of Image Curator" >> $GITHUB_OUTPUT
        fi
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ steps.get_version.outputs.TAG }}
        body: |
          # Image Curator ${{ steps.get_version.outputs.TAG }}

          ${{ steps.changelog.outputs.CHANGELOG }}

          ## Installation

          ```bash
          pip install image-curator==${{ steps.get_version.outputs.VERSION }}
          ```

          Or download the source and install:

          ```bash
          git clone https://github.com/ghostcipher1/image-curator.git
          cd image-curator
          git checkout ${{ steps.get_version.outputs.TAG }}
          pip install -e .
          ```

          ## What's New

          See the [CHANGELOG.md](CHANGELOG.md) for detailed changes.

          ## Requirements

          - Python 3.8+
          - Flickr Pro subscription (for API access)

          ## Quick Start

          ```bash
          # Configure your API key in config.py or .env
          python main.py --categories "nature,landscapes" --limit 10
          ```

          For full documentation, see the [README](README.md).
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-artifacts:
    name: Build Distribution Artifacts
    runs-on: ubuntu-latest
    needs: create-release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install build tools
      run: |
        python -m pip install --upgrade pip
        pip install build twine

    - name: Build package
      run: |
        python -m build

    - name: Check package
      run: |
        twine check dist/*

    - name: Upload artifacts to release
      uses: softprops/action-gh-release@v1
      with:
        files: dist/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
